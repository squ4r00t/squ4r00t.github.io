<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Portswigger - Cache Poisoning DOM XSS :: squ4r00t&#39;s</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="In this lab, we exploit a cache poisoning vulnerability to distribute a DOM XSS to other users" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/portswigger/cp_dom_xss/" />


  





  
  <link rel="stylesheet" href="http://localhost:1313/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/header.min.b246f77a68a20a42410f6ef10f5a4c0355e44a1e6161b71356c92d912d3ad1d2.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/main.min.c32d7e3db4c8de6935a256fcb71c56ecb26bc8db9aae57b8669429492dad067b.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">







<link rel="icon" type="image/png" href="/img/favicons/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/img/favicons/favicon.svg" />
<link rel="shortcut icon" href="/img/favicons/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/img/favicons/apple-touch-icon.png" />
<link rel="manifest" href="/img/favicons/site.webmanifest" />


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Portswigger - Cache Poisoning DOM XSS">
<meta property="og:description" content="In this lab, we exploit a cache poisoning vulnerability to distribute a DOM XSS to other users" />
<meta property="og:url" content="http://localhost:1313/portswigger/cp_dom_xss/" />
<meta property="og:site_name" content="squ4r00t&#39;s" />

  <meta property="og:image" content="http://localhost:1313/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2025-12-06 00:00:00 &#43;0000 UTC" />














</head>
<body>


<div class="container center">

  <header class="header">
  <div class="header__inner">
    
    
    
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/posts">Blog</a></li>
        
      
        
          <li><a href="/htb">HTB</a></li>
        
      
        
          <li><a href="/portswigger">Portswigger</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/posts" >Blog</a></li>
        
      
        
          <li><a href="/htb" >HTB</a></li>
        
      
        
          <li><a href="/portswigger" >Portswigger</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/portswigger/cp_dom_xss/">Portswigger - Cache Poisoning DOM XSS</a>
  </h1>
  <div class="post-meta"><time class="post-date">2025-12-06</time></div>

  
    <span class="post-tags">
      
      #<a href="http://localhost:1313/tags/portswigger/">portswigger</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/cache_poisoning/">cache_poisoning</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/dom_xss/">dom_xss</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/xss/">xss</a>&nbsp;
      
    </span>
  
  
  <img src="/portswigger/cp_dom_xss/cover.png"
    class="post-cover"
    alt="Portswigger - Cache Poisoning DOM XSS"
    title="Cover Image" />


  
    <div class="table-of-contents">
      <h2>
        Table of Contents
      </h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#lab-description">Lab Description</a></li>
    <li><a href="#finding-an-unkeyed-input">Finding an unkeyed input</a></li>
    <li><a href="#conducting-the-attack">Conducting the attack</a></li>
  </ul>
</nav>
    </div>
  

  <div class="post-content"><div>
        <h2 id="lab-description">Lab Description<a href="#lab-description" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>This lab contains a DOM-based vulnerability that can be exploited as part of a web cache poisoning attack. A user visits the home page roughly once a minute. Note that the cache used by this lab has stricter criteria for deciding which responses are cacheable, so you will need to study the cache behavior closely.</p>
<p>To solve the lab, poison the cache with a response that executes <code>alert(document.cookie)</code> in the visitor&rsquo;s browser.</p>
<h2 id="finding-an-unkeyed-input">Finding an unkeyed input<a href="#finding-an-unkeyed-input" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>First, we start by looking for an unkeyed input that can be used to elicit a malicious response. For this, we can use the Burp extension <a href="https://github.com/PortSwigger/param-miner">Param Miner</a>.</p>
<p>After scanning the home page (which is cacheable), we find that the <code>X-Forwarded-Host</code> header is an unkeyed input:</p>
<figure><img src="/img/portswigger/cp_dom_xss/unkeyed_header.png"
    alt="X-Forwarded-Host header found by Param Miner"><figcaption>
      <p>X-Forwarded-Host header found by Param Miner</p>
    </figcaption>
</figure>

<p>Next, we need to figure out in which way does this header affect the response.</p>
<p>For this, we can send the header with an arbitrary value set and see if it is reflected in the response:</p>
<figure><img src="/img/portswigger/cp_dom_xss/reflected_forwarded_host.png"
    alt="Value of the X-Forwarded-Host header reflected in the response"><figcaption>
      <p>Value of the X-Forwarded-Host header reflected in the response</p>
    </figcaption>
</figure>

<p>We can see that the value that we entered was set to the <code>host</code> attribute of the <code>data</code> object. Let&rsquo;s see where else this object is used:</p>
<figure><img src="/img/portswigger/cp_dom_xss/where_data_used.png"
    alt="Value used inside initGeoLocate()"><figcaption>
      <p>Value used inside initGeoLocate()</p>
    </figcaption>
</figure>

<p>We can see above that the value is passed as an argument to the <code>initGeoLocate()</code> function, which is imported from <code>/resources/js/geolocate.js</code>:</p>
<figure><img src="/img/portswigger/cp_dom_xss/initgeo_function.png"
    alt="Value used inside initGeoLocate()"><figcaption>
      <p>Value used inside initGeoLocate()</p>
    </figcaption>
</figure>

<p>This function will fetch some json data from the given url, then it will append the value of the <code>country</code> attribute directly (without sanitization) to the <code>innerHTML</code> sink. This is vulnerable to a DOM XSS if the json data can be altered.</p>
<p>Thanks to the <code>X-Forwarded-Host</code> header, we can specify from which url the json data is imported and that response is cacheable. This means that we can alter that url for other users as well, making the DOM XSS distributed.</p>
<h2 id="conducting-the-attack">Conducting the attack<a href="#conducting-the-attack" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>All we need to do is to serve the following json on the exploit server at <code>/resources/json/geolocate.json</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;country&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;img src=x onerror=alert(document.cookie)&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>We also need to add the <code>Access-Control-Allow-Origin: *</code> header to allow cross origin resource sharing.</p>
</blockquote>
<figure><img src="/img/portswigger/cp_dom_xss/exploit_server.png"
    alt="Exploit Server"><figcaption>
      <p>Exploit Server</p>
    </figcaption>
</figure>

<p>After storing the exploit, we need to poison the cache with the exploit server&rsquo;s domain using the <code>X-Forwarded-Host</code> header:</p>
<figure><img src="/img/portswigger/cp_dom_xss/poison_cache.png"
    alt="Poisonning the cache"><figcaption>
      <p>Poisonning the cache</p>
    </figcaption>
</figure>

<p>After refreshing the home page, we see the alert and we solved the lab:</p>
<figure><img src="/img/portswigger/cp_dom_xss/lab_solved.png"
    alt="Lab solved!"><figcaption>
      <p>Lab solved!</p>
    </figcaption>
</figure>


      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
